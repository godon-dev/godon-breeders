---
# Comprehensive parameter effectuation playbook
# Handles sysctl, sysfs, cpufreq, and ethtool parameters
# Categorizes raw params dict using Jinja2 logic
# Compatible with Windmill's minimal Ansible environment

- name: Categorize parameters by type
  hosts: localhost
  connection: local
  tasks:
    - name: Separate parameters into categories
      set_fact:
        # Sysctl parameters (net.*, kernel.*, vm.*, fs.*)
        sysctl_params_yaml: |
          {% set sysctl_dict = {} %}
          {% for key, value in params.items() %}
          {%   if key.startswith('net.') or key.startswith('kernel.') or key.startswith('vm.') or key.startswith('fs.') or key.startswith('dev.') %}
          {%     set _ = sysctl_dict.update({key: value | string}) %}
          {%   endif %}
          {% endfor %}
          {{ sysctl_dict | to_nice_json }}

        # Sysfs parameters (known sysfs paths)
        sysfs_params_yaml: |
          {% set sysfs_keys = ['cpu_governor', 'transparent_hugepage', 'qdisc'] %}
          {% set sysfs_paths = {
            'cpu_governor': '/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor',
            'transparent_hugepage': '/sys/kernel/mm/transparent_hugepage/enabled',
            'qdisc': '/sys/class/net/eth0/queue/disc'
          } %}
          {% set sysfs_dict = {} %}
          {% for key in sysfs_keys %}
          {%   if key in params %}
          {%     set _ = sysfs_dict.update({key: {'path': sysfs_paths[key], 'value': params[key] | string}}) %}
          {%   endif %}
          {% endfor %}
          {{ sysfs_dict | to_nice_json }}

        # Cpufreq parameters
        cpufreq_params_yaml: |
          {% set cpufreq_keys = ['governor', 'min_freq_ghz', 'max_freq_ghz'] %}
          {% set cpufreq_dict = {} %}
          {% for key in cpufreq_keys %}
          {%   if key in params %}
          {%     set _ = cpufreq_dict.update({key: params[key]}) %}
          {%   endif %}
          {% endfor %}
          {{ cpufreq_dict | to_nice_json }}

        # Ethtool parameters (interface-prefixed keys like "eth0_tso")
        ethtool_params_yaml: |
          {% set ethtool_dict = {} %}
          {% for key, value in params.items() %}
          {%   if '_' in key %}
          {%     set parts = key.split('_') %}
          {%     set interface = parts[0] %}
          {%     set param = parts[1:] | join('_') %}
          {%     if param in ['tso', 'gro', 'rx_ring', 'tx_ring'] %}
          {%       set _ = ethtool_dict.update({key: {'interface': interface, 'param': param, 'value': value | string}}) %}
          {%     endif %}
          {%   endif %}
          {% endfor %}
          {{ ethtool_dict | to_nice_json }}

    - name: Parse YAML to dictionaries
      set_fact:
        sysctl_params: "{{ sysctl_params_yaml | from_json }}"
        sysfs_params: "{{ sysfs_params_yaml | from_json }}"
        cpufreq_params: "{{ cpufreq_params_yaml | from_json }}"
        ethtool_params: "{{ ethtool_params_yaml | from_json }}"

- name: Write SSH key to temp file
  hosts: localhost
  connection: local
  tasks:
    - name: Write SSH private key to file
      copy:
        content: "{{ ssh_key }}"
        dest: /tmp/ansible_ssh_key
        mode: '0600'
      no_log: true

- name: Apply Linux performance parameters
  hosts: "{{ target_hostname }}"
  vars:
    ansible_host: "{{ target_hostname }}"
    ansible_user: "{{ username }}"
    ansible_ssh_private_key_file: /tmp/ansible_ssh_key
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
  become: yes
  tasks:
    - name: Log target information
      debug:
        msg:
          - "Target hostname: {{ target_hostname }}"
          - "Username: {{ username }}"

    - name: Apply sysctl parameters
      sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        reload: yes
      loop: "{{ sysctl_params | dict2items }}"
      when: sysctl_params | length > 0

    - name: Apply sysfs parameters
      copy:
        dest: "{{ item.value.path }}"
        content: "{{ item.value.value }}"
        mode: '0644'
      loop: "{{ sysfs_params | dict2items }}"
      when: sysfs_params | length > 0

    - name: Apply cpu governor via sysfs
      copy:
        dest: "/sys/devices/system/cpu/cpu0/cpufreq/scaling_governor"
        content: "{{ cpufreq_params.governor }}"
        mode: '0644'
      when: cpufreq_params.governor is defined and cpufreq_params.governor | length > 0

    - name: Apply ethtool parameters
      shell:
        cmd: "ethtool --set-{{ item.value.param }} {{ item.value.interface }} {{ item.value.value }}"
      loop: "{{ ethtool_params | dict2items }}"
      when: ethtool_params | length > 0

    - name: Generate result JSON
      set_fact:
        all_applied: >-
          {% set result = {} %}
          {% for param_dict in [sysctl_params, sysfs_params, cpufreq_params, ethtool_params] %}
          {%   for key in param_dict %}
          {%     if param_dict[key] | string | length > 0 %}
          {%       set _ = result.update({key: param_dict[key]}) %}
          {%     endif %}
          {%   endfor %}
          {% endfor %}
          {{ result | to_json }}

    - name: Write result JSON to file
      copy:
        content: "{{ { 'success': true, 'hostname': target_hostname, 'applied_count': all_applied | length, 'applied_params': all_applied | from_json } | to_json }}"
        dest: /tmp/result.json
      delegate_to: localhost
      run_once: true
